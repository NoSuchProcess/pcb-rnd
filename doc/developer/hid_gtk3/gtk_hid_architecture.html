<!DOCTYPE html>
<html lang="en">
<head>
<title>GTK HID architecture</title>
</head>
<body >
<div id="header">
<h1>GTK HID architecture</h1>
<div >
<span id="author" >Alain, Igor2</span><br>
</div>
<div id="content">
<div >
<h2 id="_situation_code_pcb_rnd_code_v1_2_1">Situation @ <code>pcb-rnd</code> v1.2.1</h2>
<div >
<div >
<p>The HIDs are plug-ins, sitting in <code>src_plugins/hid_*</code> ; GTK2 one is called <code>hid_gtk</code>.</p>
</div>
<div >
<p>First, get an instance of the main HID structure <code>pcb_hid_t</code>.
This structure is general enough. Nothing too entangled to GTK2 nor GTK3 there.</p>
</div>
<div >
<div >
<pre ><code  >pcb_hid_t pcb_gui = pcb_hid_find_gui ()</code></pre>
</div>
</div>
<div >
<p>Q: How GTK HID is initialized ?</p>
</div>
<div >
<p>A: <code>hid_hid_gtk_init ()</code> in <code>&lt;hid_gtk/gtkhid-main.c&gt;</code></p>
</div>
<div >
<p>The GUI seems to start building from <code>ghid_do_export ()</code></p>
</div>
<div >
<p>There are 2 big structures for GTK2 GUI:</p>
</div>
<div >
<div >
<pre ><code  >GhidGui _ghidgui, *ghidgui = &amp;_ghidgui;

GHidPort ghid_port, *gport;</code></pre>
</div>
</div>
<div >
<p>GTK3 compatibility within these 2 structures:</p>
</div>
<table >
<caption >Table 1. <code>GhidGui</code> structure study (portion)</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th >Type</th>
<th >GTK3 compatible</th>
<th >GTK3 replacement</th>
<th >GTK2 compatible ?</th>
</tr>
</thead>
<tbody>
<tr>
<td ><p >GtkWidget</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ></td>
<td ></td>
</tr>
<tr>
<td ><p >GtkObject</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ><p >GObject</p></td>
<td ><p >could be</p></td>
</tr>
<tr>
<td ><p >GdkPixmap</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ><p >GdkPixbuf</p></td>
<td ><p >could be</p></td>
</tr>
<tr>
<td ><p >GtkAction</p></td>
<td ><p >deprecated</p></td>
<td ><p >GAction (gio)</p></td>
<td ><p >could be (not desired)</p></td>
</tr>
<tr>
<td ><p >GtkActionGroup</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ><p >GActionGroup</p></td>
<td ><p ><span ><i ></i></span> (not desired)</p></td>
</tr>
<tr>
<td ><p >GtkEntry</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ></td>
<td ></td>
</tr>
<tr>
<td ><p >GTimeVal</p></td>
<td ><p ><span ><i ></i></span> (glib)</p></td>
<td ></td>
<td ></td>
</tr>
</tbody>
</table>
<table >
<caption >Table 2. <code>GHidPort</code> structure study (portion)</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th >Type</th>
<th >GTK+3 compatible</th>
<th >GTK+3 replacement</th>
<th >GTK+2 compatible ?</th>
</tr>
</thead>
<tbody>
<tr>
<td ><p >GtkWidget</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ></td>
<td ></td>
</tr>
<tr>
<td ><p >GdkPixmap</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ><p >GdkPixbuf</p></td>
<td ><p >could be</p></td>
</tr>
<tr>
<td ><p >GdkDrawable</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ><p >Cairo surface</p></td>
<td ><p ><span ><i ></i></span> (not desired)</p></td>
</tr>
<tr>
<td ><p >GdkColor</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ><p >GdkRGBA</p></td>
<td ><p ><span ><i ></i></span><sup>1</sup></p></td>
</tr>
<tr>
<td ><p >GdkColormap</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ><p >GdkVisual</p></td>
<td ><p ><span ><i ></i></span><sup>1</sup></p></td>
</tr>
</tbody>
</table>
<div >
<p><sup>1</sup> An abstracted structure was envisioned, but abandoned due to scarce use of color objects.</p>
</div>
</div>
</div>
<div >
<h2 id="_drawing_primitives_using_gdkx">Drawing primitives using GDKx</h2>
<div >
<div >
<h3 id="_gdk2">GDK2</h3>
<div >
<p><code>pcb-rnd</code> v1.2.1 is using <code>gdk_draw</code> functions, on an already abstracted
<code>pcb_hid_t</code> intance of <code>hid_gc_s</code> structure.</p>
</div>
<table >
<caption >Table 3. <code>hid_gc_s</code> structure study (portion)</caption>
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<thead>
<tr>
<th >Type</th>
<th >GTK+3 compatible</th>
<th >GTK+3 replacement</th>
<th >GTK+2 compatible ?</th>
</tr>
</thead>
<tbody>
<tr>
<td ><p >GdkGC</p></td>
<td ><p ><span ><i ></i></span></p></td>
<td ><p >Cairo context</p></td>
<td ><p >could be (not desired)</p></td>
</tr>
</tbody>
</table>
<div >
<p>Indirectly, a <code>GdkGC</code> needs a <code>GdkDrawable</code> which is also deprecated in GTK3.
A good replacement is a <code>GdkWindow</code>. Unfortunately <code>pcb-rnd</code> is making more use
of deprecated <code>GdkPixmap</code> objects than <code>GdkWindow</code>.</p>
</div>
<div >
<p><code>gdk_draw_line</code> has been deprecated since GTK+ 2.22. Use <code>cairo_line_to</code>
 and <code>cairo_stroke</code> instead. <code>gdk_gc_new</code> has been deprecated since GTK+ 2.22.
 Use Cairo for rendering.</p>
</div>
<div >
<p>Cairo API needs a context:</p>
</div>
<div >
<div >
<pre ><code  >cairo_line_to (cairo_t *cr,
               double x,
               double y);
cairo_t *
cairo_create (cairo_surface_t *target);</code></pre>
</div>
</div>
<div >
<p>and then pops-up the <strong>Cairo Surface</strong> !</p>
</div>
<div >
<p>A <code>cairo_surface_t</code> represents an image, either as the destination of a
drawing operation or as source when drawing onto another surface.</p>
</div>
<div >
<p>GDK does not wrap the cairo API, instead it allows to create cairo contexts
which can be used to draw on <code>GdkWindow</code>. Additional functions allow use
<code>GdkRectangles</code> with cairo and to use <code>GdkColors</code>, <code>GdkRGBAs</code>, <code>GdkPixbufs</code>
and <code>GdkWindows</code> as sources for drawing operations.</p>
</div>
</div>
<div >
<h3 id="_gdk3">GDK3</h3>

</div>
<div >
<h3 id="_cairo_interaction">Cairo Interaction</h3>
<div >
<p>Cairo is a graphics library that supports vector graphics and image compositing
that can be used with GDK. GTK+ does all of its drawing using cairo.
But I guess, it is also the case with late GDK2 !</p>
</div>
</div>
<div >
<h3 id="_open_gl">Open GL</h3>
<div >
<p><code>GdkGLContext</code> is an object representing the platform-specific OpenGL drawing context.</p>
</div>
</div>
<div >
<h3 id="_very_modern_gdk3">Very modern GDK3</h3>
<div >
<p><code>GdkDrawingContext</code> is an object that represents the current drawing state of a <code>GdkWindow</code>.
It's possible to use a <code>GdkDrawingContext</code> to draw on a <code>GdkWindow</code> via
rendering API like Cairo or OpenGL.</p>
</div>
<div >
<p>Since: 3.22</p>
</div>
</div>
</div>
</div>
<div >
<h2 id="_plans_for_code_pcb_rnd_code_v1_2_2">Plans for <code>pcb-rnd</code> v1.2.2 ?</h2>
<div >
<div >
<ol >
<li>
<p>What we must have:</p>
<div >
<ol  type="a">
<li>
<p>the old gtk2 HID, with pixmaps and all the existing obsolete code - for
existing/old systems. We won't remove or change this, there's absolutely
no reason to risk running on older systems. We probably won't remove
it in any time soon, because some people love to run real OLD systems.</p>
</li>
<li>
<p>whichever gtk HID with <strong>gl</strong> rendering; let's say <em>gtk2+gl</em>, because gtk2 is
what we have working today. This seems to be real appealing for many users.</p>
</li>
</ol>
</div>
</li>
<li>
<p><a id="future"></a> What extras we could have and totally makes sense:</p>
<div >
<ol  type="a">
<li>
<p>the new, gtk3 HID, with Cairo for sw rendering, because as far as
I understand there's no other option for sw rendering in gtk3</p>
</li>
<li>
<p>the new, gtk3 HID with <strong>gl</strong> rendering</p>
</li>
</ol>
</div>
</li>
<li>
<p>What we could temporarily have, if it helped us on our way to <a href="#future">previous</a>:</p>
<div >
<ol  type="a">
<li>
<p>a temporary, hidden, development <em>gtk2+cairo</em> implementation so
that cairo can be done in something that's already there before
gtk3 happens. This must not interfere with the gdk/pixmap implementation.
This must not remain for long in the repo, and must be converted into
the <em>gtk3+cairo</em> hid ASAP.</p>
</li>
</ol>
</div>
</li>
<li>
<p>What we shouldn't have because it doesn't make much sense but increases the
confusion and development/maintainance costs:</p>
<div >
<ol  type="a">
<li>
<p>a permanent, advertised gtk2+cairo HID. gtk2 works perfectly fine with
existing installation and the existing code. Cairo can only add slowdown
to this and introduces new build risks. Old systems don't need cairo to work.
New systems will have gtk3 sooner or layer anyway. Other than a few "obsolete"
marks in the manual, there's absolutely no issue with a <em>gtk2+pixmap</em>.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
</div>
</div>
</body>
</html>
