<html>
<body>
<H1> pcb-rnd modularization </H1>
<H2> Why bother... </H2>
I believe good software should be modular. This is especially important in
the context of large software, such as CAD applications. There should be
a thin core that can model the world and provide the basic operations defined
on it but anything else should go in separate modules.
<p>
Fortunately PCB already had a strong infrastructure supporting this idea.
It has dynamic loadable plugins and the GUI and exporters are in separate
HID modules. While working on pcb-gpmi and later pcb-rnd, I added the
gpmi module as a separate plugin.
<p>
In version 1.0.8 to 1.1.0 a cosiderable chunk of core code has been moved into
<i>core plugins</i>. A <i>core plugin</i> is just a plugin that is
maintained together with the core, in the same repository, still the code is
somewhat detached from the core. More importantly, the user can choose, for
each plugin, separately:
<ul>
	<li> to compile it as a buildin (static-link it into the pcb executable)
	<li> to compile it as a plugin (dynamic-link it runtime, if the .so is installed in the plugins/ directory)
	<li> to disable the plugin, so it is not compiled at all
</ul>
<p>
I believe such modularization has benefits on multiple levels:
<ul>
	<li> it is possible to compiler smaller, potentially faster executables by omitting features the specific user would never use anyway
	<li> in a distribution dynamic-link plugins can be distributed as separate packages providing the user with the option to decide what features to install
	<li> such plugins have to have some sort of APIs if they want to reference eachother or if the code needs to reference them; such an API may not (and often did not) exist when the code is part of the core
</ul>

<H2> Progress in charts </H2>
<h3> Before-after </h3>
All numbers are in <a href="http://en.wikipedia.org/wiki/Source_lines_of_code">SLOC</a>
and are acquired running sloccount on the given directory. While lines of
code alone is not a true measure of complexity, it's a good estimation. The
slices of pie charts are the major components of the pcb-rnd executable.
<table border=1 cellspacing=0> <tr><td>
	<table border=0>
	<tr><td><img src="before.png"><td> &nbsp; &nbsp; &nbsp; &nbsp;<td><img src="after.png">
	<tr><td>Before modularization: pcb-rnd version 1.0.7
	        <br>Note: gpmi was already a plugin
	    <td>
	    <td> After modularization: pcb-rnd version 1.1.0
	        <br>Note: gpmi is part of the "plugins" slice
	</table>
</table>
<h3>Zooming on to the plugins</h3>
<p>
<img src="mods.png">
<p>
(Red means the plugin doesn't really work).

<H2> Progress in numbers </H2>
Below is a table with the summary of core plugins.
<table border=1 cellspacing=0>
<tr><th>module <th>size [sloc] <th> status <th> configure<br>default <th> class <th> description


<tr><th align=left>autoplace<td>613
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (feature)
<td> Automatically place elements. 
<tr><th align=left>autoroute<td>4342
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (feature)
<td> Automatically route selected or all rats. This is the original autorouter. 
<tr><th align=left>dbus<td>438
<td bgcolor="red" > disabled
<br> (TODO: needs scconfig support)
<td bgcolor="red"> disabled
<td> (feature)
<td> Remote control PCB using DBUS. 
<tr><th align=left>debug<td>85
<td bgcolor="lightgreen" > works
<td bgcolor="red"> disabled
<td> (feature)
<td> Actions that help developer to debug pcb core. These are not in core because end users normally don't need these. As a plugin, due to dynamic loading, it can be dropped on an existing pcb installation with minimal risk of scaring away a reproducible bug. 
<tr><th align=left>djopt<td>2320
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (feature)
<td> Various board optimization algorithms. 
<tr><th align=left>export_bom<td>385
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> export
<td> Export bom (Bill of Materials) 
<tr><th align=left>export_dxf<td>4701
<td  >
<td >
<td>
<td> The pcb DXF HID is a DXF exporter for pcb.  The pcb DXF HID exports the loaded pcb layout to a series of DXF files, typically one file for every layer, a DXF file for inserting elements by means of "XREFS" (in AutoCAD jargon also known as eXternal REFerenced drawings), and DXF files for plated and non-plated holes.  These external referenced drawings can be 3D models of elements (ACIS), including DDE/OLE attributes of any other application that is supported by both AutoCAD (or any alternative software that supports these  features) and the (Microsoft) Operating System of your choice.  The parameters for the DXF exporter are:  --dxffile  This is the basename of the generated files. Layer-, top and bottom mask-, top and bottom paste, and drill-filenames are based upon this string.  --metric Tick for mm, default is mil.  --layer-color-BYBLOCK Tick for layer color is BYBLOCK, default layer color is BYLAYER.  --xrefs Tick for generating an eXternal REFerence file, default is none.  --xreffile This string should contain the pathname of the location where your XREF drawing files exist.  --verbose Tick if you want to see a full report on stderr of what entities are written to the files, default is silent.  --export-all-layers Tick if you want to export all layers, default is to not export empty layers.  -------------------------------------------------------------------------                             COPYRIGHT  The pcb DXF HID is covered by the GNU General Public License. See the individual files for the exact copyright notices. 
<tr><th align=left>export_gcode<td>2464
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> export
<td> Export to gcode 
<tr><th align=left>export_gerber<td>981
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> export
<td> Export to gerber 
<tr><th align=left>export_lpr<td>105
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> export
<td> Export to lpr (using export_ps to generate postscript) 
<tr><th align=left>export_nelma<td>696
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> export
<td> Export to nelma (Numerical capacitance calculator) 
<tr><th align=left>export_png<td>1115
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> export
<td> Export to png, gif and jpeg 
<tr><th align=left>export_ps<td>1634
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> export
<td> Export postscript or embedded postscript. 
<tr><th align=left>export_test<td>258
<td bgcolor="red" > disabled
<br> (work in progress)
<td bgcolor="lightgreen"> buildin
<td> export
<td> A thin layer of code to dump exporter calls for testing the HID exporter API. 
<tr><th align=left>fontmode<td>166
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (feature)
<td> Font editing actions. 
<tr><th align=left>fp_fs<td>373
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> fp
<td> Footprint: file system based implementation. Used to be called Newlib: load footprints from directories. Run external processes for the parametric footprints. 
<tr><th align=left>fp_wget<td>287
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> fp
<td> Footprint: get static (file) footprints from the web, e.g. from http://gedasymbols.org 
<tr><th align=left>gl<td>592
<td bgcolor="red" > disabled
<br> (pcb-rnd has no support for opengl.)
<td bgcolor="red"> disabled
<td> (feature)
<td> Common gl functions for hids. 
<tr><th align=left>gpmi<td>3000
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<br> (if gpmi is installed)
<td> (feature)
<td> Scriptable plugin system with about 10 scripting languages supported and dynamic load/unload of scripts that can manipulate the GUI, the board, can implement exporters, etc. 
<tr><th align=left>hid_batch<td>305
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> hid
<td> HID without GUI; read actions from stdin. 
<tr><th align=left>hid_gtk<td>13709
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> hid
<td> GUI: the GTK HID. 
<tr><th align=left>hid_lesstif<td>6914
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> hid
<td> GUI: the lesstif HID. 
<tr><th align=left>import_edif<td>3578
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> import
<td> Import code for netlists in the EDIF format. 
<tr><th align=left>import_sch<td>291
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> import
<td> Imports element and netlist data from the schematics (or some other source). 
<tr><th align=left>io_kicad_legacy<td>56
<td  > work-in-progress
<td bgcolor="red"> disabled
<td> io
<td> Load and save the design and elements in Kicad's legacy format. 
<tr><th align=left>io_pcb<td>2155
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> io
<td> Load and save the design and elements in the original pcb text format. 
<tr><th align=left>legacy_func<td>72
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (lib)
<td> Random collection of old/obsolete (legacy) functions. 3rd party plugins may depend on them. This module implements C functions and variables and does not register actions or flags. 
<tr><th align=left>mincut<td>905
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (feature)
<td> Use the minimal cut algorithm to indicate shorts: instead of highlighting two random pins/pads, try to highlight the least number of objects that connect the two networks. 
<tr><th align=left>oldactions<td>117
<td bgcolor="lightgreen" > works
<td bgcolor="red"> disabled
<td> (feature)
<td> Random collection of old/obsolete actions. Bell(): audible feedback; DumpLibrary(): print footprint library on stdout; a set of debug actions useful for writing pcb scripts: Debug(), DebugXY(), Return(). Old plugin actions to toggle or set settings that are now accessible via the unified config system (vendordrill, djopt) 
<tr><th align=left>puller<td>1887
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (feature)
<td> Pull traces to minimize their length. 
<tr><th align=left>renumber<td>222
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (feature)
<td> Renumber elements (renaming them) and generate a text file for back annotation. 
<tr><th align=left>report<td>784
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (feature)
<td> Report() and ReportObject() actions - print a report about design objects. 
<tr><th align=left>shand_cmd<td>212
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (feature)
<td> vi-like command shorthands (1..3 character long commands) 
<tr><th align=left>stroke<td>135
<td bgcolor="yellow" > partially works (doesn't work with lesstif; works with the gtk hid, but there's no zoom bindings)
<td bgcolor="red"> disabled
<td> (feature)
<td> Gesture recognition with libstroke. 
<tr><th align=left>toporouter<td>6165
<td bgcolor="red" > fails
<br> (infinite loop in gts)
<td bgcolor="red"> disabled
<td> (feature)
<td> Automatically route selected or all rats using a topological algorithm. This is the new autorouter from 2009. 
<tr><th align=left>vendordrill<td>552
<td bgcolor="lightgreen" > works
<td bgcolor="lightgreen"> buildin
<td> (feature)
<td> Vendor drill mapping. 
</table>

<H3> Classes </H3>
Each plugin implements a class (rarely a set of classes). Classes are:
<table border=1 cellspacing=0>
	<tr><th>name         <th> description
	<tr><td>(feature)    <td> random features directly accessible for the user, usually actions
	<tr><td>(lib)        <td> code library; functionality not directly accessible for the user but other plugins may depend on it
	<tr><td>hid          <td> Human Interface Device: interactive user interface, usually GUI
	<tr><td>import       <td> load alien formats into the design space
	<tr><td>export       <td> save (parts of) the design space in alien formats
	<tr><td>fp           <td> footprint (element) library implementation
	<tr><td>io           <td> native file format (save & load) implementation
</table>

</body>
</html>
